<!-- MainWindow.xaml -->
<Window x:Class="SGService.LaserRangingModule.Monitor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:SGService.LaserRangingModule.Monitor.ViewModels"
        xmlns:enums="clr-namespace:SGService.LaserRangingModule.Monitor"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="LaserRangingModuleMonitor"
        Height="450" Width="800" UseLayoutRounding="True"
        SnapsToDevicePixels="True">
    <Window.Resources>
        <!-- 建立枚舉值集合供 ComboBox 使用 -->
        <ObjectDataProvider x:Key="RangeValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <!-- 改為使用 enums 命名空間 -->
                <x:Type TypeName="enums:LrmRange"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider x:Key="ResolutionValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enums:LrmResolution"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider x:Key="FrequencyValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enums:LrmFrequency"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
    </Window.Resources>

    <DockPanel>
        <TabControl>
            <!-- Config 分頁 -->
            <TabItem Header="Config">
                <Grid Background="#FFE5E5E5">
                    <Grid Margin="12">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <!-- 0: 掃描區 -->
                            <RowDefinition Height="Auto"/>
                            <!-- 1: 參數設定區 -->
                            <RowDefinition Height="*"/>
                            <!-- 2: 列表區 -->
                        </Grid.RowDefinitions>

                        <!-- 0: 扫描/加入區域（保持原樣） -->
                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="可用 COM：" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="2" Width="220"
                          ItemsSource="{Binding AvailablePorts}"
                          SelectedItem="{Binding SelectedPortName, Mode=TwoWay}"/>
                            <Button Grid.Column="4" Width="80" Content="掃描" Command="{Binding ScanCommand}"/>
                            <Button Grid.Column="6" Width="90" Content="加入" Command="{Binding AddSelectedPortCommand}"/>
                        </Grid>

                        <!-- 1: 新增的參數設定區 -->
                        <GroupBox Grid.Row="1" Header="參數設定" Margin="0,12,0,0"
                      IsEnabled="{Binding CanConfigureSelectedPort}">
                            <Grid Margin="8">
                                <Grid.RowDefinitions>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                    <RowDefinition Height="Auto"/>
                                </Grid.RowDefinitions>
                                <Grid.ColumnDefinitions>
                                    <ColumnDefinition Width="Auto"/>
                                    <ColumnDefinition Width="8"/>
                                    <ColumnDefinition Width="*"/>
                                </Grid.ColumnDefinitions>

                                <!-- Range -->
                                <TextBlock Grid.Row="0" Grid.Column="0" Text="Range" VerticalAlignment="Center"/>
                                <ComboBox Grid.Row="0" Grid.Column="2"
                              ItemsSource="{Binding Source={StaticResource RangeValues}}"
                              SelectedItem="{Binding RangeSetting}"
                              Width="150"/>

                                <!-- Resolution -->
                                <TextBlock Grid.Row="1" Grid.Column="0" Text="Resolution" VerticalAlignment="Center"/>
                                <ComboBox Grid.Row="1" Grid.Column="2"
                              ItemsSource="{Binding Source={StaticResource ResolutionValues}}"
                              SelectedItem="{Binding ResolutionSetting}"
                              Width="150"/>

                                <!-- Frequency -->
                                <TextBlock Grid.Row="2" Grid.Column="0" Text="Frequency" VerticalAlignment="Center"/>
                                <ComboBox Grid.Row="2" Grid.Column="2"
                              ItemsSource="{Binding Source={StaticResource FrequencyValues}}"
                              SelectedItem="{Binding FrequencySetting}"
                              Width="150"/>

                                <!-- Apply 按鈕 -->
                                <Button Grid.Row="3" Grid.Column="2" Content="Apply"
                            Command="{Binding ApplySettingsCommand}"
                            Width="80" Margin="0,12,0,0"/>
                            </Grid>
                        </GroupBox>

                        <!-- 2: 原有的 ItemsControl 列表 -->
                        <!-- 2: Device List -->
                        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto" Margin="0,12,0,0">
                            <ItemsControl ItemsSource="{Binding SelectedPorts}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="8" Margin="0,0,0,4" BorderBrush="#DDD" BorderThickness="1" CornerRadius="4" Background="White">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="*"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                    <ColumnDefinition Width="Auto"/>
                                                </Grid.ColumnDefinitions>

                                                <TextBlock Grid.Column="0" Text="{Binding PortName}" FontWeight="Bold" VerticalAlignment="Center" Margin="0,0,12,0"/>
                                                <TextBlock Grid.Column="1" Text="{Binding ConnectionStatus}" VerticalAlignment="Center"/>

                                                <Button Grid.Column="2" Content="{Binding ConnectButtonText}" 
                               Command="{Binding ToggleConnectCommand}"
                               MinWidth="80" Margin="0,0,8,0"/>
                                                <Button Grid.Column="3" Content="移除" 
                               Command="{Binding RemoveCommand}"
                               MinWidth="60"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Grid>
            </TabItem>



            <TabItem Header="Measurement">
                <Grid Background="#FFE5E5E5">
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <!-- Control buttons -->
                        <RowDefinition Height="Auto"/>
                        <!-- Device selection -->
                        <RowDefinition Height="2*"/>
                        <!-- Chart area -->
                        <RowDefinition Height="1*"/>
                        <!-- Statistics -->
                    </Grid.RowDefinitions>

                    <!-- Control Panel -->
                    <GroupBox Grid.Row="0" Header="Measurement Control" Margin="12,12,12,8">
                        <Grid Margin="8">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>

                            <TextBlock Grid.Column="0" 
                      Text="Select devices for chart display, then start measurement"
                      VerticalAlignment="Center"
                      FontStyle="Italic"/>

                            <StackPanel Grid.Column="1" Orientation="Horizontal">
                                <Button Content="Start Selected" 
                       Command="{Binding StartSelectedCommand}"
                       MinWidth="100" Margin="0,0,5,0"/>
                                <Button Content="Stop All" 
                       Command="{Binding StopAllCommand}"
                       MinWidth="100"/>
                            </StackPanel>
                        </Grid>
                    </GroupBox>

                    <!-- Device Selection for Chart -->
                    <GroupBox Grid.Row="1" Header="Chart Selection" Margin="12,0,12,8">
                        <ScrollViewer VerticalScrollBarVisibility="Auto" MaxHeight="120" Margin="8">
                            <ItemsControl ItemsSource="{Binding SelectedPorts}">
                                <ItemsControl.ItemsPanel>
                                    <ItemsPanelTemplate>
                                        <WrapPanel Orientation="Horizontal"/>
                                    </ItemsPanelTemplate>
                                </ItemsControl.ItemsPanel>
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <CheckBox Content="{Binding PortName}" 
                                 IsChecked="{Binding IsSelectedForChart}"
                                 Margin="0,0,20,4"
                                 IsEnabled="{Binding IsConnected}"/>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </GroupBox>

                    <!-- Chart Area -->
                    <GroupBox Grid.Row="2" Header="Real-time Chart" Margin="12,0,12,8">
                        <Border BorderBrush="LightGray" BorderThickness="1" Background="White" Margin="8">
                            <TextBlock Text="Chart will be implemented in Step 8" 
                      HorizontalAlignment="Center" 
                      VerticalAlignment="Center"
                      FontStyle="Italic" 
                      Foreground="Gray"/>
                        </Border>
                    </GroupBox>

                    <!-- Statistics Panel -->
                    <GroupBox Grid.Row="3" Header="Statistics" Margin="12,0,12,12">
                        <Grid Margin="8">
                            <TextBlock Text="Statistics panel will be implemented in Step 9" 
                      HorizontalAlignment="Center" 
                      VerticalAlignment="Center"
                      FontStyle="Italic" 
                      Foreground="Gray"/>
                        </Grid>
                    </GroupBox>
                </Grid>
            </TabItem>

        </TabControl>
        <!-- 將 StatusBar 放在 DockPanel 內部，並正確設置 DockPanel.Dock 屬性 -->
        <StatusBar DockPanel.Dock="Bottom">
            <StatusBarItem>
                <TextBlock Text="{Binding StatusMessage}"/>
            </StatusBarItem>
            <Separator/>
            <StatusBarItem>
                <TextBlock Text="{Binding DeviceCount, StringFormat='Devices: {0}'}"/>
            </StatusBarItem>
        </StatusBar>
    </DockPanel>
</Window>
