<!-- MainWindow.xaml -->
<Window x:Class="SGService.LaserRangingModule.Monitor.MainWindow"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
        xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
        xmlns:vm="clr-namespace:SGService.LaserRangingModule.Monitor.ViewModels"
        xmlns:enums="clr-namespace:SGService.LaserRangingModule.Monitor"
        xmlns:sys="clr-namespace:System;assembly=mscorlib"
        mc:Ignorable="d"
        Title="LaserRangingModuleMonitor"
        Height="450" Width="800" UseLayoutRounding="True"
        SnapsToDevicePixels="True">
    <Window.Resources>
        <!-- 建立枚舉值集合供 ComboBox 使用 -->
        <ObjectDataProvider x:Key="RangeValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <!-- 改為使用 enums 命名空間 -->
                <x:Type TypeName="enums:LrmRange"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider x:Key="ResolutionValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enums:LrmResolution"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
        <ObjectDataProvider x:Key="FrequencyValues"
                            MethodName="GetValues"
                            ObjectType="{x:Type sys:Enum}">
            <ObjectDataProvider.MethodParameters>
                <x:Type TypeName="enums:LrmFrequency"/>
            </ObjectDataProvider.MethodParameters>
        </ObjectDataProvider>
    </Window.Resources>
    
    <Grid>
        <TabControl>
            <TabItem Header="Config">
                <Grid Background="#FFE5E5E5">
                    <Grid Margin="12" VerticalAlignment="Top">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <!-- 工具列 -->
                            <RowDefinition Height="*"/>
                            <!-- 保留空間 -->
                        </Grid.RowDefinitions>

                        <!-- Row 0：上方工具列 -->
                        <Grid Grid.Row="0">
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="Auto"/>
                                <ColumnDefinition Width="8"/>
                                <ColumnDefinition Width="Auto"/>
                            </Grid.ColumnDefinitions>
                            <TextBlock Grid.Column="0" Text="可用 COM：" VerticalAlignment="Center"/>
                            <ComboBox Grid.Column="2" Width="220"
                                      ItemsSource="{Binding AvailablePorts}"
                                      SelectedItem="{Binding SelectedPortName, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"/>
                            <Button Grid.Column="4" Width="80" Content="掃描" Command="{Binding ScanCommand}"/>
                            <Button Grid.Column="6" Width="90" Content="加入" Command="{Binding AddSelectedPortCommand}"/>
                        </Grid>
                        <!-- Row 1：參數設定區 -->
                        <ScrollViewer Grid.Row="1" VerticalScrollBarVisibility="Auto">
                            <ItemsControl ItemsSource="{Binding SelectedPorts}">
                                <ItemsControl.ItemTemplate>
                                    <DataTemplate>
                                        <Border Padding="8" Margin="0,4,0,4" BorderBrush="#DDD" BorderThickness="1" CornerRadius="4">
                                            <Grid>
                                                <Grid.ColumnDefinitions>
                                                    <ColumnDefinition Width="80"/>
                                                    <!-- Port -->
                                                    <ColumnDefinition Width="4"/>
                                                    <ColumnDefinition Width="150"/>
                                                    <!-- Range -->
                                                    <ColumnDefinition Width="4"/>
                                                    <ColumnDefinition Width="150"/>
                                                    <!-- Resolution -->
                                                    <ColumnDefinition Width="4"/>
                                                    <ColumnDefinition Width="120"/>
                                                    <!-- Frequency -->
                                                    <ColumnDefinition Width="4"/>
                                                    <ColumnDefinition Width="80"/>
                                                    <!-- Apply -->
                                                </Grid.ColumnDefinitions>

                                                <!-- 顯示 COM -->
                                                <TextBlock Grid.Column="0"
                                                           Text="{Binding Port}"
                                                           VerticalAlignment="Center"
                                                           FontWeight="Bold"/>

                                                <!-- Range 下拉選單 -->
                                                <ComboBox Grid.Column="2"
                                                          ItemsSource="{Binding Source={StaticResource RangeValues}}"
                                                          SelectedItem="{Binding Range, Mode=TwoWay}"
                                                          Width="140" />

                                                <!-- Resolution 下拉選單 -->
                                                <ComboBox Grid.Column="4"
                                                          ItemsSource="{Binding Source={StaticResource ResolutionValues}}"
                                                          SelectedItem="{Binding Resolution, Mode=TwoWay}"
                                                          Width="140" />

                                                <!-- Frequency 下拉選單 -->
                                                <ComboBox Grid.Column="6"
                                                          ItemsSource="{Binding Source={StaticResource FrequencyValues}}"
                                                          SelectedItem="{Binding Frequency, Mode=TwoWay}"
                                                          Width="100" />

                                                <!-- 套用按鈕 -->
                                                <Button Grid.Column="8"
                                                        Content="套用"
                                                        Command="{Binding ApplySettingsCommand}"
                                                        Width="70"/>
                                            </Grid>
                                        </Border>
                                    </DataTemplate>
                                </ItemsControl.ItemTemplate>
                            </ItemsControl>
                        </ScrollViewer>
                    </Grid>
                </Grid>
            </TabItem>


            <TabItem Header="Measurement">
                <Grid Background="#FFE5E5E5">
                    <Grid Margin="12" VerticalAlignment="Top">
                        <!-- 清單：綁 SelectedPorts -->
                        <ItemsControl ItemsSource="{Binding SelectedPorts}">
                            <!-- 空清單時顯示提示（可拿掉） -->
                            <ItemsControl.Style>
                                <Style TargetType="ItemsControl">
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <Trigger Property="HasItems" Value="True">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </Trigger>
                                    </Style.Triggers>
                                </Style>
                            </ItemsControl.Style>

                            <ItemsControl.ItemTemplate>
                                <DataTemplate>
                                    <Border Padding="8" Margin="0,0,0,8" BorderBrush="#DDD" BorderThickness="1" CornerRadius="4">
                                        <Grid>
                                            <Grid.ColumnDefinitions>
                                                <ColumnDefinition Width="Auto"/>
                                                <!-- COM 標籤 -->
                                                <ColumnDefinition Width="12"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <!-- ADDR 標籤 -->
                                                <ColumnDefinition Width="6"/>
                                                <ColumnDefinition Width="90"/>
                                                <!-- ADDR 輸入框 -->
                                                <ColumnDefinition Width="12"/>
                                                <ColumnDefinition Width="*"/>
                                                <!-- 參數說明 -->
                                                <ColumnDefinition Width="Auto"/>
                                                <!-- Connect/Disconnect -->
                                                <ColumnDefinition Width="8"/>
                                                <ColumnDefinition Width="Auto"/>
                                                <!-- 移除 -->
                                            </Grid.ColumnDefinitions>

                                            <TextBlock Grid.Column="0" Text="{Binding Port}" FontWeight="Bold" VerticalAlignment="Center"/>

                                            <TextBlock Grid.Column="2" Text="ADDR:" VerticalAlignment="Center"/>
                                            <TextBox Grid.Column="4"
                         Text="{Binding Address, UpdateSourceTrigger=PropertyChanged}"
                         HorizontalContentAlignment="Right"
                         VerticalContentAlignment="Center"
                         Height="28"
                         PreviewTextInput="Addr_PreviewTextInput"
                         DataObject.Pasting="Addr_Pasting"
                         IsReadOnly="{Binding IsConnected}"
                         ToolTip="0–255（連線後會鎖定）"/>

                                            <TextBlock Grid.Column="6" Text="Serial: 9600-8-N-1"
                           VerticalAlignment="Center" Opacity="0.85"/>

                                            <!-- 若你已改成 MVVM 命令 -->
                                            <Button Grid.Column="7" Width="100"
                        Content="{Binding ConnectButtonText}"
                        Command="{Binding ToggleConnectCommand}"/>
                                            <Button Grid.Column="9" Width="80" Content="移除"
                        Command="{Binding RemoveCommand}"/>

                                            
                                        </Grid>
                                    </Border>
                                </DataTemplate>
                            </ItemsControl.ItemTemplate>
                        </ItemsControl>

                        <!-- 空清單提示（可選） -->
                        <!-- Measurement 分頁底部，空清單提示 -->
                        <TextBlock Margin="0,12,0,0"
           FontStyle="Italic"
           Foreground="#666"
           Text="尚未加入任何裝置，請到 Config 分頁選擇 COM 並按「加入」。">
                            <TextBlock.Style>
                                <Style TargetType="TextBlock">
                                    <!-- 預設隱藏 -->
                                    <Setter Property="Visibility" Value="Collapsed"/>
                                    <Style.Triggers>
                                        <!-- 當 SelectedPorts.Count 為 0 時顯示 -->
                                        <DataTrigger Binding="{Binding SelectedPorts.Count}" Value="0">
                                            <Setter Property="Visibility" Value="Visible"/>
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </TextBlock.Style>
                        </TextBlock>
                    </Grid>
                </Grid>
            </TabItem>

        </TabControl>
    </Grid>
</Window>
